package com.linn.blog.service.admin;

import java.io.BufferedInputStream;
import java.io.BufferedReader;
import java.io.ByteArrayInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintWriter;
import java.sql.Connection;
import java.sql.Date;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;

import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;

import com.google.gson.Gson;
import com.linn.blog.common.Const;
import com.linn.blog.entity.extension.Article;
import com.linn.blog.entity.system.Result;
import com.linn.blog.utils.JDBCUtils;

/**
 * 文章service
 * @author Administrator
 *
 */
public class ArticleServiceImpl {

	public int addArticle(Article article) throws Exception{

		String sql = "INSERT INTO t_article (category_id,title,content,description,description_pic,last_time,is_draft) VALUES (?,?,?,?,?,?,?);";  
		
		Connection conn = JDBCUtils.getMysqlConn();
		PreparedStatement ps = conn.prepareStatement(sql);
		
		article.setLastTime(new Date(System.currentTimeMillis()));
		
		ps.setObject(1, article.getCategoryId());
		ps.setObject(2, article.getTitle());
		ps.setClob(3, new BufferedReader(new InputStreamReader(new BufferedInputStream(
				new ByteArrayInputStream(article.getContent().getBytes("utf-8"))),"utf-8")));
		ps.setObject(4, article.getDescription());
		ps.setObject(5, article.getDescriptionPic());
		ps.setObject(6, article.getLastTime());
		ps.setObject(7, Const.NO);

		int count = ps.executeUpdate();
		JDBCUtils.close(ps, conn);
		return count;
	}
	
	/**
	 * 删除文章
	 */
	private void delArticle() throws Exception {

		request.setCharacterEncoding("utf-8");
		
		Connection conn =null;
		PreparedStatement ps=null;
		
		Result result = new Result();
		result.setSuccess(true);
		result.setMsg("OK");
		try {
			String sql = "delete from t_article where id = ?;";  
			
			conn = JDBCUtils.getMysqlConn();
			ps = conn.prepareStatement(sql);
			String id = request.getParameter("id");
			
			ps.setObject(1, id);
			int count = ps.executeUpdate();
			
		} catch (SQLException e) {
			result.setSuccess(false);
			result.setMsg("failed");
			e.printStackTrace();
		}finally{
			JDBCUtils.close(ps, conn);
			response.setContentType("text/html;charset=utf-8");
			Gson g = new Gson();
			PrintWriter out = response.getWriter();
			out.write(g.toJson(result));
			out.flush();
			out.close();
		}
	}
	
	public long getNextId(){
		long nextId = 0;
		Connection conn =null;
		PreparedStatement ps=null;
		String sql = "SELECT AUTO_INCREMENT FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME='t_article';";  

		try {
			conn = JDBCUtils.getMysqlConn();
			ps = conn.prepareStatement(sql);

			ResultSet rs = ps.executeQuery();
			while(rs.next()){
				nextId = rs.getInt("AUTO_INCREMENT");
			}
		} catch (SQLException e) {
			e.printStackTrace();
			nextId= System.currentTimeMillis();
		}finally{
			JDBCUtils.close(ps, conn);
		}
		return nextId;
	}
}
